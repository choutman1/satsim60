<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>6DOF Satellite Simulator</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: monospace; }
    
    /* File Upload Menu Styles */
    #file-upload-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .menu-container {
      background-color: #111;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 20px;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      color: #eee;
    }
    
    .menu-header {
      text-align: center;
      margin-bottom: 20px;
      color: #0f0;
    }
    
    .file-upload-section {
      margin-bottom: 25px;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: bold;
      color: #0f0;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 1px solid #333;
    }
    
    .file-upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .file-upload-item {
      background-color: #222;
      border: 1px solid #444;
      border-radius: 5px;
      padding: 10px;
    }
    
    .file-upload-item label {
      display: block;
      margin-bottom: 5px;
      color: #0f0;
    }
    
    .file-upload-item input[type="file"] {
      width: 100%;
      padding: 5px;
      background-color: #333;
      border: 1px solid #555;
      color: #eee;
      border-radius: 3px;
    }
    
    .file-status {
      font-size: 12px;
      margin-top: 5px;
      color: #0ff;
    }
    
    .menu-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    
    .menu-button {
      padding: 10px 20px;
      background-color: #333;
      border: 1px solid #555;
      color: #eee;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .menu-button:hover {
      background-color: #444;
    }
    
    .start-button {
      background-color: #060;
      border-color: #090;
    }
    
    .start-button:hover {
      background-color: #080;
    }
    
    /* Simulation UI Styles */
    #status-panel { position: absolute; left: 10px; top: 10px; background: rgba(0,0,0,0.7); color: #0f0; padding: 10px; border-radius: 5px; font-size: 12px; width: 400px; }
    #controls { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 10px; border-radius: 5px; font-size: 12px; }
    #hull-info { position: absolute; right: 10px; top: 10px; background: rgba(0,0,0,0.7); color: #0f0; padding: 10px; border-radius: 5px; font-size: 12px; width: 200px; }
    #distance-info { position: absolute; left: 10px; top: 520px; background: rgba(0,0,0,0.7); color: #0ff; padding: 10px; border-radius: 5px; font-size: 12px; width: 260px; display: none; }
    .fuel-bar-container { width: 100%; height: 20px; background-color: #333; border-radius: 5px; margin-top: 5px; }
    .fuel-bar { height: 100%; background-color: #0f0; border-radius: 5px; transition: width 0.3s; }
    .momentum-bar-container { width: 100%; height: 12px; background-color: #333; border-radius: 3px; margin-top: 2px; }
    .momentum-bar { height: 100%; background-color: #0f0; border-radius: 3px; transition: width 0.3s, background-color 0.3s; }
    .status-section { margin-bottom: 10px; }
    
    /* 8-Segment Clock Styles */
    #clock-display {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #ff3333;
      font-family: 'Courier New', Courier, monospace;
      font-size: 48px;
      font-weight: bold;
      padding: 10px 20px;
      border-radius: 5px;
      border: 2px solid #ff3333;
      text-shadow: 0 0 10px #ff3333, 0 0 20px #ff3333;
      letter-spacing: 5px;
      z-index: 100;
      min-width: 200px;
      text-align: center;
    }
    
    .clock-colon {
      animation: blink 1s infinite;
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    
    /* Paused Overlay Styles */
    #paused-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 999;
      pointer-events: none;
    }
    
    #paused-text {
      font-size: 120px;
      font-weight: bold;
      color: #ff0000;
      font-family: 'Courier New', Courier, monospace;
    }
    
    #paused-instructions {
      margin-top: 30px;
      font-size: 24px;
      color: #ffffff;
      font-family: 'Courier New', Courier, monospace;
    }
    .status-section:last-child { margin-bottom: 0; }
    canvas { display: block; }
  </style>
</head>
<body>
  <!-- File Upload Menu -->
  <div id="file-upload-menu">
    <div class="menu-container">
      <h2 class="menu-header">6DOF Satellite Simulator - Configuration</h2>
      
      <!-- Navigation Links -->
      <div style="text-align: center; margin-bottom: 15px;">
        <a href="https://cghiuganiastate.github.io/satsim/editor/" target="_blank" style="color: #0f0; text-decoration: none; margin: 0 15px; font-weight: bold;">üìù Editor</a>
        <a href="https://github.com/cghiuganiastate/satsim" target="_blank" style="color: #0f0; text-decoration: none; margin: 0 15px; font-weight: bold;">üîó GitHub</a>
      </div>
      
      <p style="text-align: center; margin-bottom: 20px;">
        Upload custom configuration files or use defaults to start the simulation
      </p>
      
      <div class="file-upload-section">
        <div class="section-title">Spacecraft Model</div>
        <div class="file-upload-grid">
          <div class="file-upload-item">
            <label for="spacecraft-model-file">Spacecraft Model (.stl)</label>
            <input type="file" id="spacecraft-model-file" accept=".stl">
            <div class="file-status" id="spacecraft-model-status">No file selected</div>
          </div>
        </div>
      </div>
      
      <div class="file-upload-section">
        <div class="section-title">Docking Port</div>
        <div class="file-upload-grid">
          <div class="file-upload-item">
            <label for="docking-port-file">Docking Port Model (.stl)</label>
            <input type="file" id="docking-port-file" accept=".stl">
            <div class="file-status" id="docking-port-status">No file selected</div>
          </div>
        </div>
      </div>
      
      <div class="file-upload-section">
        <div class="section-title">Configuration File</div>
        <div class="file-upload-grid">
          <div class="file-upload-item">
            <label for="config-file">Complete Configuration (.json)</label>
            <input type="file" id="config-file" accept=".json">
            <div class="file-status" id="config-status">No file selected</div>
          </div>
        </div>
      </div>
      
      <div class="file-upload-section">
        <div class="section-title">Initial Position & Orientation</div>
        <div class="file-upload-grid">
          <div class="file-upload-item">
            <label for="position-file">Initial Position (.json)</label>
            <input type="file" id="position-file" accept=".json">
            <div class="file-status" id="position-status">No file selected</div>
          </div>
        </div>
      </div>
      
      <div class="menu-buttons">
        <button id="use-defaults-button" class="menu-button">Use Defaults</button>
        <button id="start-simulation-button" class="menu-button start-button">Start Simulation</button>
      </div>
    </div>
  </div>

  <!-- Paused Overlay -->
  <div id="paused-overlay">
    <div id="paused-text">PAUSED</div>
    <div id="paused-instructions">Press "`+P" to unpause</div>
  </div>

  <!-- Simulation UI (Initially Hidden) -->
  <div id="simulation-container" style="display: none;">
    <div id="clock-display">0:00:00</div>
    <div id="status-panel">
      <div class="status-section">
        <div>Position: <span id="position-info">X: 0.00 Y: 0.00 Z: 0.00</span></div>
        <div>Velocity: <span id="velocity-info">X: 0.00 Y: 0.00 Z: 0.00</span></div>
        <div>Angular Velocity: <span id="angular-velocity-info">X: 0.00 Y: 0.00 Z: 0.00</span></div>
        <div>Attitude (RPY): <span id="attitude-info">Roll: 0.0¬∞ Pitch: 0.0¬∞ Yaw: 0.0¬∞</span></div>
        <div>Status: <span id="status-info">RUNNING</span></div>
        <div>Camera Mode: <span id="camera-mode-info">Unknown</span></div>
        <div>Fine Control: <span id="fine-control-info">OFF</span></div>
        <div style="margin-top: 5px;">
          <input type="checkbox" id="timed-firing-toggle">
          <label for="timed-firing-toggle">Timed Firing</label>
        </div>
        <div style="margin-top: 5px;">
          <label for="firing-duration-slider">Duration: <span id="firing-duration-value">1.00</span>s</label><br>
          <input type="range" id="firing-duration-slider" min="0" max="100" step="0.1" value="0" style="width: 100%;">
        </div>
        <div style="margin-top: 5px; border-top: 1px solid #333; padding-top: 5px;">
          <label for="torque-slider">Torque Strength: <span id="torque-value">50</span>%</label><br>
          <input type="range" id="torque-slider" min="1" max="100" step="1" value="50" style="width: 100%;">
        </div>
      </div>
      
      <div class="status-section">
        <div>Fuel: <span id="fuel-percent">100</span>%</div>
        <div class="fuel-bar-container">
          <div id="fuel-bar" class="fuel-bar" style="width: 100%"></div>
        </div>
        <div style="margin-top: 5px; font-size: 10px;">
          <span>Dry Mass: <span id="dry-mass">0</span> kg</span> | 
          <span>Fuel Mass: <span id="fuel-mass">0</span> kg</span> | 
          <span>Total Mass: <span id="total-mass">0</span> kg</span>
        </div>
      </div>
      
      <div class="status-section">
        <div>Attitude Control: <span id="control-mode">Thrusters</span></div>
        <div id="reaction-wheel-status" style="display: none; margin-top: 5px;">
          <div style="font-size: 10px;">Reaction Wheels:</div>
          <div id="rw-list"></div>
        </div>
        <div id="cmg-status" style="display: none; margin-top: 5px;">
          <div style="font-size: 10px;">CMGs:</div>
          <div id="cmg-list"></div>
        </div>
        <div id="desaturation-status" style="display: none; margin-top: 5px; color: #ff0;">
          Desaturation Active
        </div>
      </div>
      
      <div class="status-section">
        <div>Lights: <span id="lamp-status-text">OFF</span></div>
        <div style="margin-top: 5px; font-size: 10px;">
          <span>Lamps: <span id="lamp-count">0</span></span>
        </div>
      </div>
      
      <div class="status-section">
        <button id="export-position-button" class="menu-button" style="width: 100%; padding: 5px; font-size: 11px;">Export Current Position & Orientation</button>
      </div>
      
      <div class="status-section">
        <div>Docking Status: <span id="docking-status" style="color: #0ff;">DOCKED</span></div>
        <div>Distance to Dock: <span id="dock-distance">--</span> m</div>
        <div>Angular Difference: <span id="angular-diff">--</span>¬∞</div>
        <div>Speed: <span id="docking-speed">--</span> m/s</div>
        <div>Angular Speed: <span id="docking-angular-speed">--</span>¬∞/s</div>
      </div>
    </div>
    <div id="distance-info">
      <div>Distance to Nearest Wall:</div>
      <div style="margin-top: 5px;">X+: <span id="dist-x-pos">--</span> | X-: <span id="dist-x-neg">--</span></div>
      <div>Y+: <span id="dist-y-pos">--</span> | Y-: <span id="dist-y-neg">--</span></div>
      <div>Z+: <span id="dist-z-pos">--</span> | Z-: <span id="dist-z-neg">--</span></div>
    </div>
    <div id="controls">
      <strong>Translation:</strong> W/S: +Z/-Z | A/D: +X/-X | E/Q: +Y/-Y<br>
      <strong>Rotation:</strong> K/I: +Pitch/-Pitch | J/L: +Yaw/-Yaw | O/U: +Roll/-Roll<br>
      <strong>Attitude Control:</strong> T: Toggle Control Mode(RCS/RW/CMG)<br>
      <strong>Lights and Camera:</strong> V: Toggle Lights | C: Switch Camera<br>
      <strong>State:</strong> `+R: Reset | `+P: Pause/Unpause | Space: Stop Movement and Rotation<br>
      <strong>Fine Control:</strong> Caps Lock: Single-frame & timed thruster pulses
    </div>
    <div id="hull-info">
      <div id="hull-status">Loading Navion...</div>
      <div id="hull-count">Hull Count: 0</div>
    </div>
  </div>

  <script>
        if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        //navigator.serviceWorker.register('./sw.js', { scope: './' }) //testing
        navigator.serviceWorker.register('/satsim/sw.js', { scope: '/satsim/' }) //deployed
          .then(reg => console.log('SW registered:', reg.scope))
          .catch(err => console.error('SW registration failed:', err));
      });
    }
  </script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.168.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.168.0/examples/jsm/",
      "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
    }
  }
  </script>
  <script type="module">
    // File Upload Menu JavaScript
    const fileUploadMenu = document.getElementById('file-upload-menu');
    const simulationContainer = document.getElementById('simulation-container');
    const useDefaultsButton = document.getElementById('use-defaults-button');
    const startSimulationButton = document.getElementById('start-simulation-button');
    
    // Store uploaded files
    const uploadedFiles = {
      config: null,
      spacecraftModel: null,
      dockingPort: null,
      initialPosition: null
    };
    
    // File input elements
    const fileInputs = {
      config: document.getElementById('config-file'),
      spacecraftModel: document.getElementById('spacecraft-model-file'),
      dockingPort: document.getElementById('docking-port-file'),
      initialPosition: document.getElementById('position-file')
    };
    
    // Status elements
    const statusElements = {
      config: document.getElementById('config-status'),
      spacecraftModel: document.getElementById('spacecraft-model-status'),
      dockingPort: document.getElementById('docking-port-status'),
      initialPosition: document.getElementById('position-status')
    };
    
    // Add event listeners to file inputs
    fileInputs.config.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const content = JSON.parse(e.target.result);
            // Validate the combined config structure
            if (validateCombinedConfig(content)) {
              uploadedFiles.config = content;
              statusElements.config.textContent = `Loaded: ${file.name}`;
              statusElements.config.style.color = '#0f0';
            } else {
              statusElements.config.textContent = `Invalid configuration format`;
              statusElements.config.style.color = '#f00';
            }
          } catch (error) {
            statusElements.config.textContent = `Error parsing ${file.name}: ${error.message}`;
            statusElements.config.style.color = '#f00';
            console.error(`Error parsing ${file.name}:`, error);
          }
        };
        reader.readAsText(file);
      } else {
        uploadedFiles.config = null;
        statusElements.config.textContent = 'No file selected';
        statusElements.config.style.color = '#0ff';
      }
    });
    
    fileInputs.spacecraftModel.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedFiles.spacecraftModel = e.target.result;
          statusElements.spacecraftModel.textContent = `Loaded: ${file.name}`;
          statusElements.spacecraftModel.style.color = '#0f0';
        };
        reader.readAsArrayBuffer(file);
      } else {
        uploadedFiles.spacecraftModel = null;
        statusElements.spacecraftModel.textContent = 'No file selected';
        statusElements.spacecraftModel.style.color = '#0ff';
      }
    });
    
    fileInputs.dockingPort.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedFiles.dockingPort = e.target.result;
          statusElements.dockingPort.textContent = `Loaded: ${file.name}`;
          statusElements.dockingPort.style.color = '#0f0';
        };
        reader.readAsArrayBuffer(file);
      } else {
        uploadedFiles.dockingPort = null;
        statusElements.dockingPort.textContent = 'No file selected';
        statusElements.dockingPort.style.color = '#0ff';
      }
    });
    
    fileInputs.initialPosition.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const content = JSON.parse(e.target.result);
            // Validate the position data structure
            if (validatePositionData(content)) {
              uploadedFiles.initialPosition = content;
              statusElements.initialPosition.textContent = `Loaded: ${file.name}`;
              statusElements.initialPosition.style.color = '#0f0';
            } else {
              statusElements.initialPosition.textContent = `Invalid position format`;
              statusElements.initialPosition.style.color = '#f00';
            }
          } catch (error) {
            statusElements.initialPosition.textContent = `Error parsing ${file.name}: ${error.message}`;
            statusElements.initialPosition.style.color = '#f00';
            console.error(`Error parsing ${file.name}:`, error);
          }
        };
        reader.readAsText(file);
      } else {
        uploadedFiles.initialPosition = null;
        statusElements.initialPosition.textContent = 'No file selected (will use defaults)';
        statusElements.initialPosition.style.color = '#0ff';
      }
    });
    
    // Function to validate position data
    function validatePositionData(content) {
      // Check for required fields
      if (typeof content?.position?.x !== 'number') return false;
      if (typeof content?.position?.y !== 'number') return false;
      if (typeof content?.position?.z !== 'number') return false;
      if (typeof content?.orientation?.x !== 'number') return false;
      if (typeof content?.orientation?.y !== 'number') return false;
      if (typeof content?.orientation?.z !== 'number') return false;
      if (typeof content?.orientation?.w !== 'number') return false;
      return true;
    }
    
    // Function to validate combined configuration (accepts both unified and baked formats)
    function validateCombinedConfig(content) {
      // Check for required sections
      const requiredSections = ['cameras', 'cmg', 'spacecraftProperties', 'lamps', 'reactionwheels', 'thrusters'];
      for (const section of requiredSections) {
        if (!content[section]) {
          console.warn(`Missing section in config: ${section}`);
          return false;
        }
      }
      
      // Validate cameras: accepts either direct array or nested object
      if (!Array.isArray(content.cameras) && !Array.isArray(content.cameras?.cameras)) return false;
      
      // Validate CMG: accepts either array or nested object
      const cmgData = Array.isArray(content.cmg) ? { cmgs: content.cmg } : content.cmg;
      if (typeof cmgData?.cmgs !== 'object' && !Array.isArray(cmgData?.cmgs)) return false;
      
      // Validate spacecraft properties
      if (typeof content.spacecraftProperties?.dryMass !== 'number') return false;
      
      // Validate lamps: accepts either direct array or nested object
      const lampsData = Array.isArray(content.lamps) ? { lamps: content.lamps } : content.lamps;
      if (!Array.isArray(lampsData?.lamps)) return false;
      
      // Validate reaction wheels: accepts either direct array or nested object
      const rwData = Array.isArray(content.reactionwheels) ? { wheels: content.reactionwheels } : content.reactionwheels;
      if (!Array.isArray(rwData?.wheels)) return false;
      
      // Validate thrusters: accepts either direct array or nested object
      const thrustersData = Array.isArray(content.thrusters) ? { thrusters: content.thrusters } : content.thrusters;
      if (!Array.isArray(thrustersData?.thrusters)) return false;
      
      return true;
    }
    
    // Use defaults button
    useDefaultsButton.addEventListener('click', () => {
      // Clear all uploaded files
      uploadedFiles.config = null;
      uploadedFiles.spacecraftModel = null;
      uploadedFiles.dockingPort = null;
      uploadedFiles.initialPosition = null;
      fileInputs.config.value = '';
      fileInputs.spacecraftModel.value = '';
      fileInputs.dockingPort.value = '';
      fileInputs.initialPosition.value = '';
      statusElements.config.textContent = 'No file selected';
      statusElements.config.style.color = '#0ff';
      statusElements.spacecraftModel.textContent = 'No file selected';
      statusElements.spacecraftModel.style.color = '#0ff';
      statusElements.dockingPort.textContent = 'No file selected';
      statusElements.dockingPort.style.color = '#0ff';
      statusElements.initialPosition.textContent = 'No file selected (will use defaults)';
      statusElements.initialPosition.style.color = '#0ff';
    });
    
    // Start simulation button
    startSimulationButton.addEventListener('click', () => {
      // Hide the menu and show the simulation
      fileUploadMenu.style.display = 'none';
      simulationContainer.style.display = 'block';
      
      // Make uploadedFiles available globally for the simulation
      window.uploadedFiles = uploadedFiles;
      
      // Dispatch a custom event to signal that simulation should start
      window.dispatchEvent(new CustomEvent('startSimulation'));
      
      // Set up export button functionality
      setupExportButton();
    });
    
    // Function to set up the export button
    function setupExportButton() {
      const exportButton = document.getElementById('export-position-button');
      if (exportButton) {
        exportButton.addEventListener('click', () => {
          // Request the simulation to export current position/orientation
          window.dispatchEvent(new CustomEvent('exportPosition'));
        });
      }
    }
  </script>
  
  <!-- Simulation script (initially waits for the start event) -->
  <script type="module" src="simulation.js"></script>
</body>
</html>
